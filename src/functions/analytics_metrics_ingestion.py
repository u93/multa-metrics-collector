import json
import time

from handlers.analytics.iot_analytics import IotAnalyticsHandler
from handlers.utils import base_response
from settings.aws import IOT_ANALYTICS_CHANNEL_0
from settings.logs import Logger

logs_handler = Logger()
logger = logs_handler.get_logger()


def lambda_handler(event, context):
    activation_time = round(time.time())
    logger.info(activation_time)
    logger.info(event)

    analytics_handler = IotAnalyticsHandler()
    event_list = list()
    for record in event["Records"]:
        event_list.append(json.loads(record["body"]))

    put_message_status = analytics_handler.batch_put_message(
        channel_name=IOT_ANALYTICS_CHANNEL_0, messages=event_list, analysis="cold_path_metrics"
    )
    logger.info(put_message_status)

    return base_response(status_code=200)


if __name__ == "__main__":
    event = {
        "Records": [
            {
                "messageId": "380826c0-6076-4513-b5ec-f060abb9b5bd",
                "receiptHandle": "AQEBlJA9exsGzg0tp8OC0kKlA03/KUuHCOrh+sQZfMlR10MBJOL/3jrdTx5ZY4i4zmWPIUBpMoZHKUCjjxdkfvfrs4ZaaOzsDsGwql9mvQ2QyO03GNCdqUmnDZP1nhn7YtEfgT/CnTxPT4/LXLH1tL+NY+SepUZbJ8xkmhYu/TV/uxy7hM6/V9OwW9GH7YBz8DUdv6ZlONvjkRhcAsw+X70OkL/OI0UnV/1yrw+hSS9fUTIhNeDI5SRqXOdPjQ2dItPNp58smCztEJr/Y/gAR+NGJV6eP4GeUgCM7JmiGq0M2760xjjXL+1EinH7do+a1N1hvgD8jFqXmmUxAgcnTnGe8E85iz7+V2eWg7dvIKAgj+O0JpXb0mF/dGB7rYlLqWR7wCFjMKAph8aR+s1EVGjOqk8/MkGWUBQuLUdJArVKXcm90fboMviypvHKnWFV7QzC",
                "body": '{"previous":{"state":{"reported":{"ram_info":{"raw":{"memory":{"total":8238596096,"available":7688372224,"percent":6.7,"used":274223104,"free":5935628288,"shared":1282048,"buffers":87117824,"cached":1941626880},"swap":{"total":0,"used":0,"free":0,"percent":0}},"insights":{"current":550223872,"total":1941626880,"percent":1941626880,"status":false}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[0,0],"freq_per_cpu":[2416,2416],"avg_load_times":[0,0,0],"avg_load_percent_times":[0,0,0]},"insights":{"percent":0,"high":false}},"disk_dynamic_info":{"current":8454266880,"total":490652508160,"percent":2,"high":false,"general_io":{"read_count":71049,"write_count":13995,"read_bytes":802751488,"write_bytes":1906479616,"read_time":71049,"write_time":1179768}},"temp_info":{"raw":{"current":120,"total":221,"per_core":{"acpitz":[{"label":"","current":80,"high":194,"critical":194}],"coretemp":[{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221},{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221}],"soc_dts0":[]}},"insights":{"percent":54,"high":false}},"boot_time_info":{"raw":{"last_boot_timestamp":1591286216,"current_date":"2020-06-04 22:45:22.657998"},"insights":{"last_boot":"2020-06-04 15:56:56","days_since_boot":0,"seconds_since_boot":24507,"high":false}},"battery_info":{},"fans_info":{},"bw_info":{"current":0},"hardware":{"machine":"x86_64","processor":"","name":0},"platform":{"system":"Linux","node":"test_server_2","release":"4.15.0-91-generic","version":"#92-Ubuntu SMP Fri Feb 28 11:09:48 UTC 2020","machine":"","processor":"","architecture":"64bit","libc_version":"glibc 2.2.5"},"cpu_static_info":{"physical_cpu_count":2,"logical_cpu_count":2,"cpu_affinity":2,"min_cpu_freq":1333,"max_cpu_freq":2416,"per_cpu_freq":[{"min":1333,"max":2416},{"min":1333,"max":2416}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/device-data:/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/sys:/sys:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/:/rootfs:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/proc:/prochost:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/resolv.conf":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hostname":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hosts":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/run:/var/run:rw":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/run/docker.sock:/var/run/docker.sock":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/lib/docker/:/var/lib/docker:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"}}}}},"metadata":{"reported":{"ram_info":{"raw":{"memory":{"total":{"timestamp":1591581882},"available":{"timestamp":1591581882},"percent":{"timestamp":1591581882},"used":{"timestamp":1591581882},"free":{"timestamp":1591581882},"shared":{"timestamp":1591581882},"buffers":{"timestamp":1591581882},"cached":{"timestamp":1591581882}},"swap":{"total":{"timestamp":1591581882},"used":{"timestamp":1591581882},"free":{"timestamp":1591581882},"percent":{"timestamp":1591581882}}},"insights":{"current":{"timestamp":1591581882},"total":{"timestamp":1591581882},"percent":{"timestamp":1591581882},"status":{"timestamp":1591581882}}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[{"timestamp":1591581882},{"timestamp":1591581882}],"freq_per_cpu":[{"timestamp":1591581882},{"timestamp":1591581882}],"avg_load_times":[{"timestamp":1591581882},{"timestamp":1591581882},{"timestamp":1591581882}],"avg_load_percent_times":[{"timestamp":1591581882},{"timestamp":1591581882},{"timestamp":1591581882}]},"insights":{"percent":{"timestamp":1591581882},"high":{"timestamp":1591581882}}},"disk_dynamic_info":{"current":{"timestamp":1591581882},"total":{"timestamp":1591581882},"percent":{"timestamp":1591581882},"high":{"timestamp":1591581882},"general_io":{"read_count":{"timestamp":1591581882},"write_count":{"timestamp":1591581882},"read_bytes":{"timestamp":1591581882},"write_bytes":{"timestamp":1591581882},"read_time":{"timestamp":1591581882},"write_time":{"timestamp":1591581882}}},"temp_info":{"raw":{"current":{"timestamp":1591581882},"total":{"timestamp":1591581882},"per_core":{"acpitz":[{"label":{"timestamp":1591581882},"current":{"timestamp":1591581882},"high":{"timestamp":1591581882},"critical":{"timestamp":1591581882}}],"coretemp":[{"label":{"timestamp":1591581882},"current":{"timestamp":1591581882},"high":{"timestamp":1591581882},"critical":{"timestamp":1591581882}},{"label":{"timestamp":1591581882},"current":{"timestamp":1591581882},"high":{"timestamp":1591581882},"critical":{"timestamp":1591581882}},{"label":{"timestamp":1591581882},"current":{"timestamp":1591581882},"high":{"timestamp":1591581882},"critical":{"timestamp":1591581882}},{"label":{"timestamp":1591581882},"current":{"timestamp":1591581882},"high":{"timestamp":1591581882},"critical":{"timestamp":1591581882}}],"soc_dts0":[]}},"insights":{"percent":{"timestamp":1591581882},"high":{"timestamp":1591581882}}},"boot_time_info":{"raw":{"last_boot_timestamp":{"timestamp":1591581882},"current_date":{"timestamp":1591581882}},"insights":{"last_boot":{"timestamp":1591581882},"days_since_boot":{"timestamp":1591581882},"seconds_since_boot":{"timestamp":1591581882},"high":{"timestamp":1591581882}}},"battery_info":{},"fans_info":{},"bw_info":{"current":{"timestamp":1591581882}},"hardware":{"machine":{"timestamp":1591581882},"processor":{"timestamp":1591581882},"name":{"timestamp":1591581882}},"platform":{"system":{"timestamp":1591581882},"node":{"timestamp":1591581882},"release":{"timestamp":1591581882},"version":{"timestamp":1591581882},"machine":{"timestamp":1591581882},"processor":{"timestamp":1591581882},"architecture":{"timestamp":1591581882},"libc_version":{"timestamp":1591581882}},"cpu_static_info":{"physical_cpu_count":{"timestamp":1591581882},"logical_cpu_count":{"timestamp":1591581882},"cpu_affinity":{"timestamp":1591581882},"min_cpu_freq":{"timestamp":1591581882},"max_cpu_freq":{"timestamp":1591581882},"per_cpu_freq":[{"min":{"timestamp":1591581882},"max":{"timestamp":1591581882}},{"min":{"timestamp":1591581882},"max":{"timestamp":1591581882}}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/device-data:/device":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/sys:/sys:ro":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/:/rootfs:ro":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/proc:/prochost:ro":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/etc/resolv.conf":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/etc/hostname":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/etc/hosts":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/var/run:/var/run:rw":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/run/docker.sock:/var/run/docker.sock":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}},"/var/lib/docker/:/var/lib/docker:ro":{"device":{"timestamp":1591581882},"fstype":{"timestamp":1591581882},"opts":{"timestamp":1591581882}}}}}},"version":27046},"current":{"state":{"reported":{"ram_info":{"raw":{"memory":{"total":8238596096,"available":7688372224,"percent":6.7,"used":274223104,"free":5935628288,"shared":1282048,"buffers":87117824,"cached":1941626880},"swap":{"total":0,"used":0,"free":0,"percent":0}},"insights":{"current":550223872,"total":1941626880,"percent":1941626880,"status":false}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[0,0],"freq_per_cpu":[2416,2416],"avg_load_times":[0,0,0],"avg_load_percent_times":[0,0,0]},"insights":{"percent":0,"high":false}},"disk_dynamic_info":{"current":8454266880,"total":490652508160,"percent":2,"high":false,"general_io":{"read_count":71049,"write_count":13995,"read_bytes":802751488,"write_bytes":1906479616,"read_time":71049,"write_time":1179768}},"temp_info":{"raw":{"current":120,"total":221,"per_core":{"acpitz":[{"label":"","current":80,"high":194,"critical":194}],"coretemp":[{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221},{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221}],"soc_dts0":[]}},"insights":{"percent":54,"high":false}},"boot_time_info":{"raw":{"last_boot_timestamp":1591286216,"current_date":"2020-06-04 22:45:22.657998"},"insights":{"last_boot":"2020-06-04 15:56:56","days_since_boot":0,"seconds_since_boot":24507,"high":false}},"battery_info":{},"fans_info":{},"bw_info":{"current":0},"hardware":{"machine":"x86_64","processor":"","name":0},"platform":{"system":"Linux","node":"test_server_2","release":"4.15.0-91-generic","version":"#92-Ubuntu SMP Fri Feb 28 11:09:48 UTC 2020","machine":"","processor":"","architecture":"64bit","libc_version":"glibc 2.2.5"},"cpu_static_info":{"physical_cpu_count":2,"logical_cpu_count":2,"cpu_affinity":2,"min_cpu_freq":1333,"max_cpu_freq":2416,"per_cpu_freq":[{"min":1333,"max":2416},{"min":1333,"max":2416}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/device-data:/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/sys:/sys:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/:/rootfs:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/proc:/prochost:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/resolv.conf":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hostname":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hosts":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/run:/var/run:rw":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/run/docker.sock:/var/run/docker.sock":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/lib/docker/:/var/lib/docker:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"}}}}},"metadata":{"reported":{"ram_info":{"raw":{"memory":{"total":{"timestamp":1591581892},"available":{"timestamp":1591581892},"percent":{"timestamp":1591581892},"used":{"timestamp":1591581892},"free":{"timestamp":1591581892},"shared":{"timestamp":1591581892},"buffers":{"timestamp":1591581892},"cached":{"timestamp":1591581892}},"swap":{"total":{"timestamp":1591581892},"used":{"timestamp":1591581892},"free":{"timestamp":1591581892},"percent":{"timestamp":1591581892}}},"insights":{"current":{"timestamp":1591581892},"total":{"timestamp":1591581892},"percent":{"timestamp":1591581892},"status":{"timestamp":1591581892}}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[{"timestamp":1591581892},{"timestamp":1591581892}],"freq_per_cpu":[{"timestamp":1591581892},{"timestamp":1591581892}],"avg_load_times":[{"timestamp":1591581892},{"timestamp":1591581892},{"timestamp":1591581892}],"avg_load_percent_times":[{"timestamp":1591581892},{"timestamp":1591581892},{"timestamp":1591581892}]},"insights":{"percent":{"timestamp":1591581892},"high":{"timestamp":1591581892}}},"disk_dynamic_info":{"current":{"timestamp":1591581892},"total":{"timestamp":1591581892},"percent":{"timestamp":1591581892},"high":{"timestamp":1591581892},"general_io":{"read_count":{"timestamp":1591581892},"write_count":{"timestamp":1591581892},"read_bytes":{"timestamp":1591581892},"write_bytes":{"timestamp":1591581892},"read_time":{"timestamp":1591581892},"write_time":{"timestamp":1591581892}}},"temp_info":{"raw":{"current":{"timestamp":1591581892},"total":{"timestamp":1591581892},"per_core":{"acpitz":[{"label":{"timestamp":1591581892},"current":{"timestamp":1591581892},"high":{"timestamp":1591581892},"critical":{"timestamp":1591581892}}],"coretemp":[{"label":{"timestamp":1591581892},"current":{"timestamp":1591581892},"high":{"timestamp":1591581892},"critical":{"timestamp":1591581892}},{"label":{"timestamp":1591581892},"current":{"timestamp":1591581892},"high":{"timestamp":1591581892},"critical":{"timestamp":1591581892}},{"label":{"timestamp":1591581892},"current":{"timestamp":1591581892},"high":{"timestamp":1591581892},"critical":{"timestamp":1591581892}},{"label":{"timestamp":1591581892},"current":{"timestamp":1591581892},"high":{"timestamp":1591581892},"critical":{"timestamp":1591581892}}],"soc_dts0":[]}},"insights":{"percent":{"timestamp":1591581892},"high":{"timestamp":1591581892}}},"boot_time_info":{"raw":{"last_boot_timestamp":{"timestamp":1591581892},"current_date":{"timestamp":1591581892}},"insights":{"last_boot":{"timestamp":1591581892},"days_since_boot":{"timestamp":1591581892},"seconds_since_boot":{"timestamp":1591581892},"high":{"timestamp":1591581892}}},"battery_info":{},"fans_info":{},"bw_info":{"current":{"timestamp":1591581892}},"hardware":{"machine":{"timestamp":1591581892},"processor":{"timestamp":1591581892},"name":{"timestamp":1591581892}},"platform":{"system":{"timestamp":1591581892},"node":{"timestamp":1591581892},"release":{"timestamp":1591581892},"version":{"timestamp":1591581892},"machine":{"timestamp":1591581892},"processor":{"timestamp":1591581892},"architecture":{"timestamp":1591581892},"libc_version":{"timestamp":1591581892}},"cpu_static_info":{"physical_cpu_count":{"timestamp":1591581892},"logical_cpu_count":{"timestamp":1591581892},"cpu_affinity":{"timestamp":1591581892},"min_cpu_freq":{"timestamp":1591581892},"max_cpu_freq":{"timestamp":1591581892},"per_cpu_freq":[{"min":{"timestamp":1591581892},"max":{"timestamp":1591581892}},{"min":{"timestamp":1591581892},"max":{"timestamp":1591581892}}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/device-data:/device":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/sys:/sys:ro":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/:/rootfs:ro":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/proc:/prochost:ro":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/etc/resolv.conf":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/etc/hostname":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/etc/hosts":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/var/run:/var/run:rw":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/run/docker.sock:/var/run/docker.sock":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}},"/var/lib/docker/:/var/lib/docker:ro":{"device":{"timestamp":1591581892},"fstype":{"timestamp":1591581892},"opts":{"timestamp":1591581892}}}}}},"version":27047},"timestamp":1591581892,"serial_number":"multa-agent-compose-i386-241"}',
                "attributes": {
                    "ApproximateReceiveCount": "1",
                    "SentTimestamp": "1591581892253",
                    "SenderId": "AROARUOR3MSSLQPUPGGEZ:4zmJSjlv",
                    "ApproximateFirstReceiveTimestamp": "1591581892254",
                },
                "messageAttributes": {},
                "md5OfBody": "b448c201aedb52a7376d7410da9f1972",
                "eventSource": "aws:sqs",
                "eventSourceARN": "arn:aws:sqs:us-east-1:112646120612:multa_backend_analytics_ingestion_queue_queue_dev",
                "awsRegion": "us-east-1",
            }
        ]
    }
    lambda_handler(event=event, context={})
