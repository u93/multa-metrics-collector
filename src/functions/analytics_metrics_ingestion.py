import json
import os
import time

from handlers.data_analysis.iot_analytics import IotAnalyticsHandler
from handlers.utils import base_response
from settings.aws import IOT_ANALYTICS_CHANNEL_0
from settings.logs import Logger

logs_handler = Logger()
logger = logs_handler.get_logger()


def lambda_handler(event, context):
    activation_time = round(time.time())
    logger.info(activation_time)
    logger.info(event)

    analytics_handler = IotAnalyticsHandler()
    event_list = list()
    for record in event["Records"]:
        event_list.append(json.loads(record["body"]))

    put_message_status = analytics_handler.batch_put_message(channel_name=IOT_ANALYTICS_CHANNEL_0, messages=event_list)
    logger.info(put_message_status)

    return base_response(status_code=200)


if __name__ == "__main__":
    event = {
        "Records": [
            {
                "messageId": "dfe4bf23-e1d0-4dd7-bd1b-cefbe9e40cb5",
                "receiptHandle": "AQEBHy0Vlecmr/43icQ6rA6RyikDM7gT6DqjLbcS/NY7fiPGkHrHDAzvglnm/kSHJ5t8y1eV9d1zGsHuE8YUo5OLNRR1UGpzw4pintUnnBXuhmg3jAMkCO5ZEMfi/q4FX2f1bYxvmSx16K7nQSTE9tDUZb9byZ8WlhkzOePNcw/c+/g6BFwlCKIWSx6gb3PPBuTayZfAoxHD40fMVQzT3C/f39cURxrrJgDI4oHGzlyYAl0s/IFKFSXekzVJEmtmLfk5CxxOAPYu/AVzxGtYzfu7GHmoCBVtPHiPlPifrsUSQr0o4HgXiJgpfdNeS0GSvOvOhiCXwyrcrD+uvF4bDnefiMHmFR1jUeN+/cPS+xN47w91QqFwvffFbg0RU4dh0asY0UPh7DRJEcWmMHq9jMosBP9jwMtVZfujMpAuekzScaraKOXcJ2rhGBVJW4c3aA11",
                "body": '{"previous":{"state":{"reported":{"ram_info":{"raw":{"memory":{"total":8238596096,"available":7688372224,"percent":6.7,"used":274223104,"free":5935628288,"shared":1282048,"buffers":87117824,"cached":1941626880},"swap":{"total":0,"used":0,"free":0,"percent":0.0}},"insights":{"current":550223872,"total":1941626880,"percent":1941626880,"status":false}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[0,0],"freq_per_cpu":[2416,2416],"avg_load_times":[0,0,0],"avg_load_percent_times":[0,0,0]},"insights":{"percent":0,"high":false}},"disk_dynamic_info":{"current":8454266880,"total":490652508160,"percent":2,"high":false,"general_io":{"read_count":71049,"write_count":13995,"read_bytes":802751488,"write_bytes":1906479616,"read_time":71049,"write_time":1179768}},"temp_info":{"raw":{"current":120,"total":221,"per_core":{"acpitz":[{"label":"","current":80,"high":194,"critical":194}],"coretemp":[{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221},{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221}],"soc_dts0":[]}},"insights":{"percent":54,"high":false}},"boot_time_info":{"raw":{"last_boot_timestamp":1.591286216E9,"current_date":"2020-06-04 22:45:22.657998"},"insights":{"last_boot":"2020-06-04 15:56:56","days_since_boot":0,"seconds_since_boot":24507,"high":false}},"battery_info":{},"fans_info":{},"bw_info":{"current":0},"hardware":{"machine":"x86_64","processor":"","name":0},"platform":{"system":"Linux","node":"test_server_2","release":"4.15.0-91-generic","version":"#92-Ubuntu SMP Fri Feb 28 11:09:48 UTC 2020","machine":"","processor":"","architecture":"64bit","libc_version":"glibc 2.2.5"},"cpu_static_info":{"physical_cpu_count":2,"logical_cpu_count":2,"cpu_affinity":2,"min_cpu_freq":1333,"max_cpu_freq":2416,"per_cpu_freq":[{"min":1333,"max":2416},{"min":1333,"max":2416}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/device-data:/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/sys:/sys:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/:/rootfs:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/proc:/prochost:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/resolv.conf":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hostname":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hosts":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/run:/var/run:rw":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/run/docker.sock:/var/run/docker.sock":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/lib/docker/:/var/lib/docker:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"}}}}},"metadata":{"reported":{"ram_info":{"raw":{"memory":{"total":{"timestamp":1591570891},"available":{"timestamp":1591570891},"percent":{"timestamp":1591570891},"used":{"timestamp":1591570891},"free":{"timestamp":1591570891},"shared":{"timestamp":1591570891},"buffers":{"timestamp":1591570891},"cached":{"timestamp":1591570891}},"swap":{"total":{"timestamp":1591570891},"used":{"timestamp":1591570891},"free":{"timestamp":1591570891},"percent":{"timestamp":1591570891}}},"insights":{"current":{"timestamp":1591570891},"total":{"timestamp":1591570891},"percent":{"timestamp":1591570891},"status":{"timestamp":1591570891}}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[{"timestamp":1591570891},{"timestamp":1591570891}],"freq_per_cpu":[{"timestamp":1591570891},{"timestamp":1591570891}],"avg_load_times":[{"timestamp":1591570891},{"timestamp":1591570891},{"timestamp":1591570891}],"avg_load_percent_times":[{"timestamp":1591570891},{"timestamp":1591570891},{"timestamp":1591570891}]},"insights":{"percent":{"timestamp":1591570891},"high":{"timestamp":1591570891}}},"disk_dynamic_info":{"current":{"timestamp":1591570891},"total":{"timestamp":1591570891},"percent":{"timestamp":1591570891},"high":{"timestamp":1591570891},"general_io":{"read_count":{"timestamp":1591570891},"write_count":{"timestamp":1591570891},"read_bytes":{"timestamp":1591570891},"write_bytes":{"timestamp":1591570891},"read_time":{"timestamp":1591570891},"write_time":{"timestamp":1591570891}}},"temp_info":{"raw":{"current":{"timestamp":1591570891},"total":{"timestamp":1591570891},"per_core":{"acpitz":[{"label":{"timestamp":1591570891},"current":{"timestamp":1591570891},"high":{"timestamp":1591570891},"critical":{"timestamp":1591570891}}],"coretemp":[{"label":{"timestamp":1591570891},"current":{"timestamp":1591570891},"high":{"timestamp":1591570891},"critical":{"timestamp":1591570891}},{"label":{"timestamp":1591570891},"current":{"timestamp":1591570891},"high":{"timestamp":1591570891},"critical":{"timestamp":1591570891}},{"label":{"timestamp":1591570891},"current":{"timestamp":1591570891},"high":{"timestamp":1591570891},"critical":{"timestamp":1591570891}},{"label":{"timestamp":1591570891},"current":{"timestamp":1591570891},"high":{"timestamp":1591570891},"critical":{"timestamp":1591570891}}],"soc_dts0":[]}},"insights":{"percent":{"timestamp":1591570891},"high":{"timestamp":1591570891}}},"boot_time_info":{"raw":{"last_boot_timestamp":{"timestamp":1591570891},"current_date":{"timestamp":1591570891}},"insights":{"last_boot":{"timestamp":1591570891},"days_since_boot":{"timestamp":1591570891},"seconds_since_boot":{"timestamp":1591570891},"high":{"timestamp":1591570891}}},"battery_info":{},"fans_info":{},"bw_info":{"current":{"timestamp":1591570891}},"hardware":{"machine":{"timestamp":1591570891},"processor":{"timestamp":1591570891},"name":{"timestamp":1591570891}},"platform":{"system":{"timestamp":1591570891},"node":{"timestamp":1591570891},"release":{"timestamp":1591570891},"version":{"timestamp":1591570891},"machine":{"timestamp":1591570891},"processor":{"timestamp":1591570891},"architecture":{"timestamp":1591570891},"libc_version":{"timestamp":1591570891}},"cpu_static_info":{"physical_cpu_count":{"timestamp":1591570891},"logical_cpu_count":{"timestamp":1591570891},"cpu_affinity":{"timestamp":1591570891},"min_cpu_freq":{"timestamp":1591570891},"max_cpu_freq":{"timestamp":1591570891},"per_cpu_freq":[{"min":{"timestamp":1591570891},"max":{"timestamp":1591570891}},{"min":{"timestamp":1591570891},"max":{"timestamp":1591570891}}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/device-data:/device":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/sys:/sys:ro":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/:/rootfs:ro":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/proc:/prochost:ro":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/etc/resolv.conf":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/etc/hostname":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/etc/hosts":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/var/run:/var/run:rw":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/run/docker.sock:/var/run/docker.sock":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}},"/var/lib/docker/:/var/lib/docker:ro":{"device":{"timestamp":1591570891},"fstype":{"timestamp":1591570891},"opts":{"timestamp":1591570891}}}}}},"version":25950},"current":{"state":{"reported":{"ram_info":{"raw":{"memory":{"total":8238596096,"available":7688372224,"percent":6.7,"used":274223104,"free":5935628288,"shared":1282048,"buffers":87117824,"cached":1941626880},"swap":{"total":0,"used":0,"free":0,"percent":0.0}},"insights":{"current":550223872,"total":1941626880,"percent":1941626880,"status":false}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[0,0],"freq_per_cpu":[2416,2416],"avg_load_times":[0,0,0],"avg_load_percent_times":[0,0,0]},"insights":{"percent":0,"high":false}},"disk_dynamic_info":{"current":8454266880,"total":490652508160,"percent":2,"high":false,"general_io":{"read_count":71049,"write_count":13995,"read_bytes":802751488,"write_bytes":1906479616,"read_time":71049,"write_time":1179768}},"temp_info":{"raw":{"current":120,"total":221,"per_core":{"acpitz":[{"label":"","current":80,"high":194,"critical":194}],"coretemp":[{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221},{"label":"Core 0","current":120,"high":221,"critical":221},{"label":"Core 1","current":120,"high":221,"critical":221}],"soc_dts0":[]}},"insights":{"percent":54,"high":false}},"boot_time_info":{"raw":{"last_boot_timestamp":1.591286216E9,"current_date":"2020-06-04 22:45:22.657998"},"insights":{"last_boot":"2020-06-04 15:56:56","days_since_boot":0,"seconds_since_boot":24507,"high":false}},"battery_info":{},"fans_info":{},"bw_info":{"current":0},"hardware":{"machine":"x86_64","processor":"","name":0},"platform":{"system":"Linux","node":"test_server_2","release":"4.15.0-91-generic","version":"#92-Ubuntu SMP Fri Feb 28 11:09:48 UTC 2020","machine":"","processor":"","architecture":"64bit","libc_version":"glibc 2.2.5"},"cpu_static_info":{"physical_cpu_count":2,"logical_cpu_count":2,"cpu_affinity":2,"min_cpu_freq":1333,"max_cpu_freq":2416,"per_cpu_freq":[{"min":1333,"max":2416},{"min":1333,"max":2416}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/device-data:/device":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/sys:/sys:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/:/rootfs:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/proc:/prochost:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/resolv.conf":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hostname":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/etc/hosts":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/run:/var/run:rw":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/run/docker.sock:/var/run/docker.sock":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"},"/var/lib/docker/:/var/lib/docker:ro":{"device":"/dev/sda2","fstype":"ext4","opts":"rw,relatime,data=ordered"}}}}},"metadata":{"reported":{"ram_info":{"raw":{"memory":{"total":{"timestamp":1591570901},"available":{"timestamp":1591570901},"percent":{"timestamp":1591570901},"used":{"timestamp":1591570901},"free":{"timestamp":1591570901},"shared":{"timestamp":1591570901},"buffers":{"timestamp":1591570901},"cached":{"timestamp":1591570901}},"swap":{"total":{"timestamp":1591570901},"used":{"timestamp":1591570901},"free":{"timestamp":1591570901},"percent":{"timestamp":1591570901}}},"insights":{"current":{"timestamp":1591570901},"total":{"timestamp":1591570901},"percent":{"timestamp":1591570901},"status":{"timestamp":1591570901}}},"cpu_dynamic_info":{"raw":{"percent_per_cpu":[{"timestamp":1591570901},{"timestamp":1591570901}],"freq_per_cpu":[{"timestamp":1591570901},{"timestamp":1591570901}],"avg_load_times":[{"timestamp":1591570901},{"timestamp":1591570901},{"timestamp":1591570901}],"avg_load_percent_times":[{"timestamp":1591570901},{"timestamp":1591570901},{"timestamp":1591570901}]},"insights":{"percent":{"timestamp":1591570901},"high":{"timestamp":1591570901}}},"disk_dynamic_info":{"current":{"timestamp":1591570901},"total":{"timestamp":1591570901},"percent":{"timestamp":1591570901},"high":{"timestamp":1591570901},"general_io":{"read_count":{"timestamp":1591570901},"write_count":{"timestamp":1591570901},"read_bytes":{"timestamp":1591570901},"write_bytes":{"timestamp":1591570901},"read_time":{"timestamp":1591570901},"write_time":{"timestamp":1591570901}}},"temp_info":{"raw":{"current":{"timestamp":1591570901},"total":{"timestamp":1591570901},"per_core":{"acpitz":[{"label":{"timestamp":1591570901},"current":{"timestamp":1591570901},"high":{"timestamp":1591570901},"critical":{"timestamp":1591570901}}],"coretemp":[{"label":{"timestamp":1591570901},"current":{"timestamp":1591570901},"high":{"timestamp":1591570901},"critical":{"timestamp":1591570901}},{"label":{"timestamp":1591570901},"current":{"timestamp":1591570901},"high":{"timestamp":1591570901},"critical":{"timestamp":1591570901}},{"label":{"timestamp":1591570901},"current":{"timestamp":1591570901},"high":{"timestamp":1591570901},"critical":{"timestamp":1591570901}},{"label":{"timestamp":1591570901},"current":{"timestamp":1591570901},"high":{"timestamp":1591570901},"critical":{"timestamp":1591570901}}],"soc_dts0":[]}},"insights":{"percent":{"timestamp":1591570901},"high":{"timestamp":1591570901}}},"boot_time_info":{"raw":{"last_boot_timestamp":{"timestamp":1591570901},"current_date":{"timestamp":1591570901}},"insights":{"last_boot":{"timestamp":1591570901},"days_since_boot":{"timestamp":1591570901},"seconds_since_boot":{"timestamp":1591570901},"high":{"timestamp":1591570901}}},"battery_info":{},"fans_info":{},"bw_info":{"current":{"timestamp":1591570901}},"hardware":{"machine":{"timestamp":1591570901},"processor":{"timestamp":1591570901},"name":{"timestamp":1591570901}},"platform":{"system":{"timestamp":1591570901},"node":{"timestamp":1591570901},"release":{"timestamp":1591570901},"version":{"timestamp":1591570901},"machine":{"timestamp":1591570901},"processor":{"timestamp":1591570901},"architecture":{"timestamp":1591570901},"libc_version":{"timestamp":1591570901}},"cpu_static_info":{"physical_cpu_count":{"timestamp":1591570901},"logical_cpu_count":{"timestamp":1591570901},"cpu_affinity":{"timestamp":1591570901},"min_cpu_freq":{"timestamp":1591570901},"max_cpu_freq":{"timestamp":1591570901},"per_cpu_freq":[{"min":{"timestamp":1591570901},"max":{"timestamp":1591570901}},{"min":{"timestamp":1591570901},"max":{"timestamp":1591570901}}]},"disk_static_nfo":{"partitions_info":{"/device":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/device-data:/device":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/sys:/sys:ro":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/:/rootfs:ro":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/proc:/prochost:ro":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/etc/resolv.conf":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/etc/hostname":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/etc/hosts":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/var/run:/var/run:rw":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/run/docker.sock:/var/run/docker.sock":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}},"/var/lib/docker/:/var/lib/docker:ro":{"device":{"timestamp":1591570901},"fstype":{"timestamp":1591570901},"opts":{"timestamp":1591570901}}}}}},"version":25951},"timestamp":1591570901}',
                "attributes": {
                    "ApproximateReceiveCount": "1",
                    "SentTimestamp": "1591570901997",
                    "SenderId": "AROARUOR3MSSLQPUPGGEZ:PXyoqa09",
                    "ApproximateFirstReceiveTimestamp": "1591570901999",
                },
                "messageAttributes": {},
                "md5OfBody": "fc8d3d5899f0c74e4e78d2b0a812b13b",
                "eventSource": "aws:sqs",
                "eventSourceARN": "arn:aws:sqs:us-east-1:112646120612:multa_backend_analytics_ingestion_queue_queue_dev",
                "awsRegion": "us-east-1",
            }
        ]
    }
    lambda_handler(event=event, context={})
